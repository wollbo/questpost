{% extends "base.html" %}
<!-- 
    This page allows for the creation of quests 
-->

{% block title %} Profile {% endblock %}
{% block content %}
{% if request.user.is_authenticated %}
<div class="quest-creation-container">
    <div class="user-info">
        <p>Authenticated as {{ user }}</p>   
    </div>
    <div class="task-selection-container" style="margin-top: 20px;">
        <select class="task-dropdown" name="task" id="tasks" onchange="updateTaskIndex()">
            <option value="0">Spotify popularity</option> <!-- Api follower of account -->
            <option value="1">Google ranking</option> <!-- -->
            <option value="2">Twitter Followers</option>
        </select>
    </div>
    <div class="quest-form">
        <input type="text" id="input-eth" placeholder="Enter reward amount">
        <input type="text" id="input-duration" placeholder="Enter duration in days"> <!-- Change to calendar select -->
        <input type="text" id="input-target" placeholder="Enter target value"> <!-- Link this to task -->
        <input type="text" id="input-args" placeholder="Enter arguments separated by comma"> <!--Make this conditional on task index -->
        <div class="new-quest-button-container">
            <button id="new-quest">New Quest</button>
        </div>
    </div>
</div>
{% endif %}
<script>

    const CONTRACT_ADDRESS = "0xA8094Dc8877925ff583a026b32e8Fa991267Fe65" // change to from .env file 
    const newQuestBtn = document.getElementById("new-quest")

    let taskIndex = "0";
    function updateTaskIndex() {
        taskIndex = document.getElementById("tasks").value;
    }

    let rewardValue;
    function updateRewardValue() {
        rewardValue = document.getElementById("input-eth").value;
        console.log(rewardValue);
    }

    let durationValue;
    function updateDurationValue() {
        durationValue = document.getElementById("input-duration").value;
        console.log(durationValue);
    }

    let targetValue;
    function updateTargetValue() {
        targetValue = document.getElementById("input-target").value;
        console.log(targetValue);
    }

    let args;
    function updateArgsValue() {
        args = document.getElementById("input-args").value.split(',').map(arg => arg.trim());
        console.log(args);
    }

    async function createNewQuest(event) {
        let jsonData;
        await fetch("{% url 'web3:fetch_abi' %}")
            .then(response => response.json())
            .then(data => jsonData = data)

        console.log(jsonData);

        const { ethereum } = window;
        const provider = new ethers.providers.Web3Provider(ethereum);
        const signer = provider.getSigner()
        const connectedContract = new ethers.Contract(CONTRACT_ADDRESS, jsonData, signer)

        var inWei = (parseFloat(rewardValue.replace(/,/g, '.')) * 10 ** 18).toString()
        var inDays = (parseFloat(durationValue.replace(/,/g, '.')) * 86400).toString()

        let questParams = {
            target: targetValue,
            reward: inWei,
            questIndex: taskIndex,
            duration: inDays,
            args: args
        };
        console.log(questParams)

        let tx = await connectedContract.newQuest(questParams, { value: inWei });

    }

    document.getElementById("input-eth").oninput = updateRewardValue;
    document.getElementById("input-duration").oninput = updateDurationValue;
    document.getElementById("input-target").oninput = updateTargetValue;
    document.getElementById("input-args").oninput = updateArgsValue;
    document.getElementById("new-quest").addEventListener("click", createNewQuest);
</script>
{% endblock %}